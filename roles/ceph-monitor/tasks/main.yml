---
# Basic Ceph monitor installation for Fedora
# - initialize primary monitor on the first host in group `ceph_monitors`
# - create keyrings, monmap and mkfs on primary
# - fetch required files to controller and copy them to other monitors

- name: Install Ceph packages (Fedora)
  become: true
  dnf:
    name: "{{ ceph_packages | default(['ceph-common', 'ceph-mon', 'ceph-mgr', 'ceph-mgr-dashboard']) }}"
    state: present

- name: Install all Ceph manager modules (Fedora)
  become: true
  shell: |
    dnf install -y ceph-mgr-* 2>/dev/null || true
  args:
    executable: /bin/bash
  changed_when: false

- name: Ensure /etc/ceph exists
  become: true
  file:
    path: /etc/ceph
    state: directory
    owner: root
    group: root
    mode: "0755"

# PRIMARY: run once on the first ceph monitor to create fsid, ceph.conf, keyrings and monmap
- name: Generate cluster FSID (primary)
  become: true
  command: uuidgen
  register: ceph_fsid
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Set FSID fact (primary)
  become: true
  set_fact:
    ceph_cluster_fsid: "{{ ceph_fsid.stdout }}"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Render ceph.conf on primary
  become: true
  template:
    src: ceph.conf.j2
    dest: /etc/ceph/ceph.conf
    owner: root
    group: root
    mode: "0644"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Build monmap arguments (primary)
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  set_fact:
    _monmap_args: ""

- name: Append monmap args per monitor (primary)
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  set_fact:
    _monmap_args: "{{ (_monmap_args | default('')) + '--add ' + (hostvars[mon].get('ansible_hostname', mon)) + ' ' + (hostvars[mon].get('ansible_host', mon)) + ' ' }}"
  loop: "{{ groups['ceph_monitors'] }}"
  loop_control:
    loop_var: mon

  ## Debug monmap args
- name: Debug monmap args (primary)
  debug:
    msg: "_monmap_args={{ _monmap_args }}"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Check if keyrings already exist (primary)
  become: true
  stat:
    path: /etc/ceph/ceph.mon.keyring
  register: mon_keyring_stat
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Create monitor keyrings and monmap (primary)
  become: true
  shell: |
    set -e
    # create monitor keyring
    ceph-authtool --create-keyring /etc/ceph/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'
    # create admin keyring
    ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --cap mon 'allow *' --cap osd 'allow *' --cap mgr 'allow *'
    # import admin keyring into mon keyring so monitor recognizes client.admin
    ceph-authtool /etc/ceph/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
    # remove existing monmap (monmaptool will error if file exists)
    rm -f /tmp/monmap || true
    # create monmap including all monitors
    monmaptool --create {{ _monmap_args }} /tmp/monmap
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_keyring_stat.stat.exists
  run_once: true

- name: Read monmap content (primary)
  become: true
  command: monmaptool --print /tmp/monmap
  register: monmap_raw
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

- name: Extract FSID from monmap output (primary)
  set_fact:
    monmap_fsid: "{{ (monmap_raw.stdout_lines | select('match','^fsid') | list | first | default('')) | regex_replace('^fsid\\s+','') }}"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Update `fsid` in /etc/ceph/ceph.conf from monmap (primary)
  become: true
  ini_file:
    path: /etc/ceph/ceph.conf
    section: global
    option: fsid
    value: "{{ monmap_fsid }}"
    backup: yes
  when: inventory_hostname == groups['ceph_monitors'][0] and monmap_fsid is defined and monmap_fsid != ''
  run_once: true

- name: Debug monmap args (primary)
  debug:
    msg: "_monmap_args={{ _monmap_args }}"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Check if monitor already initialized (primary)
  become: true
  stat:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}/store.db"
  register: mon_initialized_stat
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Create monitor data directory (primary)
  become: true
  file:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_initialized_stat.stat.exists
  run_once: true

- name: Initialize monitor (mkfs) on primary
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}
    ceph-mon -i "$mon_name" --mkfs --monmap /tmp/monmap --keyring /etc/ceph/ceph.mon.keyring
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_initialized_stat.stat.exists
  run_once: true

- name: Ensure monitor data directory ownership (primary)
  become: true
  file:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}"
    owner: ceph
    group: ceph
    recurse: yes
    mode: "0750"
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_initialized_stat.stat.exists
  run_once: true

- name: Ensure keyrings ownership and permissions (primary)
  become: true
  file:
    path: "/etc/ceph/{{ item }}"
    owner: ceph
    group: ceph
    mode: "0600"
  loop:
    - ceph.mon.keyring
    - ceph.client.admin.keyring
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_initialized_stat.stat.exists
  run_once: true

- name: Enable and start ceph-mon service (primary)
  become: true
  systemd:
    name: "ceph-mon@{{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}"
    enabled: true
    state: started
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

# DASHBOARD: setup Ceph dashboard on primary monitor
- name: Create mgr data directory (primary)
  become: true
  file:
    path: "/var/lib/ceph/mgr/ceph-{{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}"
    state: directory
    owner: ceph
    group: ceph
    mode: "0750"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Fetch primary ceph files to controller
  fetch:
    src: "{{ item.src }}"
    dest: /tmp/ceph-setup/primary/
    flat: yes
  with_items:
    - { src: "/etc/ceph/ceph.conf" }
    - { src: "/etc/ceph/ceph.mon.keyring" }
    - { src: "/etc/ceph/ceph.client.admin.keyring" }
    - { src: "/tmp/monmap" }
  when: inventory_hostname == groups['ceph_monitors'][0] and not mon_initialized_stat.stat.exists
  run_once: true

# SECONDARY: copy files from controller (populated from primary) to other monitors and initialize
- name: Wait for primary SSH to be reachable (others)
  when: inventory_hostname != groups['ceph_monitors'][0]
  wait_for:
    host: "{{ hostvars[groups['ceph_monitors'][0]].ansible_default_ipv4.address | default(hostvars[groups['ceph_monitors'][0]].ansible_host) }}"
    port: 22
    timeout: 120

- name: Copy ceph.conf from controller to monitor
  become: true
  copy:
    src: /tmp/ceph-setup/primary/ceph.conf
    dest: /etc/ceph/ceph.conf
    owner: root
    group: root
    mode: "0644"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Copy monmap to /tmp/monmap on host
  become: true
  copy:
    src: /tmp/ceph-setup/primary/monmap
    dest: /tmp/monmap
    owner: root
    group: root
    mode: "0644"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Copy keyrings to monitor
  become: true
  copy:
    src: /tmp/ceph-setup/primary/{{ item }}
    dest: /etc/ceph/{{ item }}
    owner: root
    group: root
    mode: "0600"
  with_items:
    - ceph.mon.keyring
    - ceph.client.admin.keyring
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Create monitor data directory
  become: true
  file:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}"
    state: directory
    owner: ceph
    group: ceph
    mode: "0750"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Check if monitor already initialized (secondary)
  become: true
  stat:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}/store.db"
  register: mon_initialized_secondary_stat
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Initialize monitor (mkfs) on secondary
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}
    ceph-mon -i "$mon_name" --mkfs --monmap /tmp/monmap --keyring /etc/ceph/ceph.mon.keyring
  args:
    executable: /bin/bash
  when: inventory_hostname != groups['ceph_monitors'][0] and not mon_initialized_secondary_stat.stat.exists

- name: Ensure monitor data directory ownership (secondary)
  become: true
  file:
    path: "/var/lib/ceph/mon/ceph-{{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}"
    owner: ceph
    group: ceph
    recurse: yes
    mode: "0750"
  when: inventory_hostname != groups['ceph_monitors'][0] and not mon_initialized_secondary_stat.stat.exists

- name: Ensure keyrings ownership and permissions (secondary)
  become: true
  file:
    path: "/etc/ceph/{{ item }}"
    owner: ceph
    group: ceph
    mode: "0600"
  loop:
    - ceph.mon.keyring
    - ceph.client.admin.keyring
  when: inventory_hostname != groups['ceph_monitors'][0] and not mon_initialized_secondary_stat.stat.exists

- name: Enable and start ceph-mon service (secondary)
  become: true
  systemd:
    name: "ceph-mon@{{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}"
    enabled: true
    state: started
  when: inventory_hostname != groups['ceph_monitors'][0]

# QUORUM SYNCHRONIZATION: Wait for all monitors to form quorum before mgr setup
- name: Wait for all monitors to form quorum (before mgr setup)
  become: true
  wait_for:
    host: "{{ hostvars[mon].get('ansible_host', mon) }}"
    port: 6789
    timeout: 120
  loop: "{{ groups['ceph_monitors'] }}"
  loop_control:
    loop_var: mon
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Verify cluster has quorum
  become: true
  shell: |
    export CEPH_ARGS="--connect-timeout 5"
    for i in {1..24}; do
      if ceph mon stat -f json 2>/dev/null | grep -q "quorum"; then
        echo "Cluster has quorum"
        exit 0
      fi
      sleep 5
    done
    echo "Quorum not formed after 120 seconds"
    exit 1
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

# PRIMARY MGR/DASHBOARD SETUP: now that quorum is formed
- name: Create mgr keyring (primary)
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}
    mgr_keyring="/var/lib/ceph/mgr/ceph-${mon_name}/keyring"
    if [ ! -f "$mgr_keyring" ]; then
      ceph auth get-or-create mgr.${mon_name} mon 'allow profile mgr' osd 'allow *' mds 'allow *' -o "$mgr_keyring"
      chown ceph:ceph "$mgr_keyring"
      chmod 0600 "$mgr_keyring"
    fi
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

# - name: Reinstall ceph-mgr package to restore service file (primary)
#   become: true
#   shell: dnf reinstall -y ceph-mgr
#   when: inventory_hostname == groups['ceph_monitors'][0]
#   run_once: true

- name: Create override directory for ceph-mgr (primary)
  become: true
  file:
    path: /etc/systemd/system/ceph-mgr@.service.d
    state: directory
    mode: "0755"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Create override.conf to ensure service works (primary)
  become: true
  copy:
    content: |
      [Unit]
    dest: /etc/systemd/system/ceph-mgr@.service.d/override.conf
    mode: "0644"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Reload systemd daemon (primary)
  become: true
  shell: systemctl daemon-reload
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Enable and start ceph-mgr service (primary)
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[groups['ceph_monitors'][0]].get('ansible_hostname', hostvars[groups['ceph_monitors'][0]]['inventory_hostname']) }}
    systemctl enable "ceph-mgr@${mon_name}"
    systemctl start "ceph-mgr@${mon_name}"
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Wait for mgr to be active
  become: true
  command: ceph mgr dump -f json
  register: mgr_status
  until: mgr_status.rc == 0
  retries: 12
  delay: 5
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

- name: Enable Ceph dashboard module
  become: true
  command: ceph mgr module enable dashboard --force
  register: dashboard_enable
  failed_when: dashboard_enable.rc != 0 and 'already enabled' not in dashboard_enable.stderr
  changed_when: "'already enabled' not in dashboard_enable.stderr"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

- name: Enable all available Ceph manager modules
  become: true
  shell: |
    set +e
    # List of common modules to enable
    for module in balancer crash devicehealth influx iostat progress prometheus status telegraf telemetry rbd_support rgw osd_perf_query pg_autoscaler mds_autoscaler; do
      ceph mgr module enable "$module" --force 2>/dev/null || true
    done
    set -e
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

- name: Set dashboard SSL and port (optional, for simplicity)
  become: true
  shell: |
    set +e
    # Try to disable SSL if supported in this version
    ceph config set mgr mgr/dashboard/ssl false 2>/dev/null || true
    # Set dashboard port
    ceph config set mgr mgr/dashboard/server_port {{ ceph_dashboard_port | default('8080') }} 2>/dev/null || true
    # Set dashboard address
    ceph config set mgr mgr/dashboard/server_addr 0.0.0.0 2>/dev/null || true
    set -e
  args:
    executable: /bin/bash
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

- name: Create or update dashboard admin user
  become: true
  vars:
    dashboard_pwd: "{{ ceph_dashboard_password | default('admin') }}"
  shell: |
    export CEPH_ARGS="--connect-timeout 5"
    echo -n "$DASHBOARD_PWD" > /tmp/dashboard_pwd.txt
    ceph dashboard ac-user-create admin administrator --force-password -i /tmp/dashboard_pwd.txt 2>/dev/null || \
    ceph dashboard ac-user-set-password admin --force-password -i /tmp/dashboard_pwd.txt 2>/dev/null || true
    rm -f /tmp/dashboard_pwd.txt
  args:
    executable: /bin/bash
  environment:
    DASHBOARD_PWD: "{{ dashboard_pwd }}"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true
  changed_when: false

- name: Display dashboard access information
  debug:
    msg:
      - "Ceph Dashboard is now available with High Availability!"
      - "Active mgr (dashboard): Check with 'ceph mgr stat'"
      - "Access via any monitor IP: http://<monitor-ip>:{{ ceph_dashboard_port | default('8080') }}"
      - "Monitor IPs: {{ groups['ceph_monitors'] | map('extract', hostvars, 'ansible_host') | list | join(', ') }}"
      - "Username: admin"
      - "Password: {{ ceph_dashboard_password | default('admin') }}"
      - "Note: Dashboard will automatically failover to standby mgr if active fails"
  when: inventory_hostname == groups['ceph_monitors'][0]
  run_once: true

# DASHBOARD HA: setup standby mgr on secondary monitors
- name: Create mgr data directory (secondary)
  become: true
  file:
    path: "/var/lib/ceph/mgr/ceph-{{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}"
    state: directory
    owner: ceph
    group: ceph
    mode: "0750"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Create mgr keyring (secondary)
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}
    mgr_keyring="/var/lib/ceph/mgr/ceph-${mon_name}/keyring"
    if [ ! -f "$mgr_keyring" ]; then
      ceph auth get-or-create mgr.${mon_name} mon 'allow profile mgr' osd 'allow *' mds 'allow *' -o "$mgr_keyring"
      chown ceph:ceph "$mgr_keyring"
      chmod 0600 "$mgr_keyring"
    fi
  args:
    executable: /bin/bash
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Reinstall ceph-mgr package to restore service file (secondary)
  become: true
  shell: dnf reinstall -y ceph-mgr
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Create override directory for ceph-mgr (secondary)
  become: true
  file:
    path: /etc/systemd/system/ceph-mgr@.service.d
    state: directory
    mode: "0755"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Create override.conf to ensure service works (secondary)
  become: true
  copy:
    content: |
      [Unit]
    dest: /etc/systemd/system/ceph-mgr@.service.d/override.conf
    mode: "0644"
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Reload systemd daemon (secondary)
  become: true
  shell: systemctl daemon-reload
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Enable and start ceph-mgr service (secondary)
  become: true
  shell: |
    set -e
    mon_name={{ hostvars[inventory_hostname].get('ansible_hostname', inventory_hostname) }}
    systemctl enable "ceph-mgr@${mon_name}"
    systemctl start "ceph-mgr@${mon_name}"
  args:
    executable: /bin/bash
  when: inventory_hostname != groups['ceph_monitors'][0]

- name: Display HA dashboard information
  debug:
    msg:
      - "Standby mgr daemon is now running on {{ inventory_hostname }}"
      - "This mgr will automatically take over if the active mgr fails"
  when: inventory_hostname != groups['ceph_monitors'][0]
